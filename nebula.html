<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nebula | AI-Driven Geometry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0;
        background-color: #050508;
        font-family: "Inter", sans-serif;
        overflow-x: hidden;
      }
      canvas {
        display: block;
        outline: none;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #050508;
      }
      ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 3px;
      }

      /* Glassmorphism Utilities */
      .glass {
        background: rgba(10, 10, 15, 0.6);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .glass-panel {
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(20px);
        border-left: 1px solid rgba(0, 255, 255, 0.1);
      }

      /* Animations */
      .fade-in-up {
        animation: fadeInUp 0.8s ease-out forwards;
        opacity: 0;
        transform: translateY(20px);
      }
      .delay-100 {
        animation-delay: 0.1s;
      }
      .delay-200 {
        animation-delay: 0.2s;
      }
      .delay-300 {
        animation-delay: 0.3s;
      }

      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Loader */
      .loader {
        width: 12px;
        height: 12px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-top-color: #22d3ee;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="text-slate-300 antialiased selection:bg-cyan-500/30">
    <!-- Navigation -->
    <nav
      class="fixed top-0 w-full z-50 px-6 py-4 flex justify-between items-center pointer-events-none"
    >
      <div
        class="glass px-4 py-2 rounded-full pointer-events-auto flex items-center gap-3 fade-in-up"
      >
        <div
          id="core-status"
          class="w-2 h-2 bg-cyan-400 rounded-full shadow-[0_0_8px_rgba(34,211,238,0.8)] animate-pulse"
        ></div>
        <span class="font-bold tracking-wider text-white text-sm">NEBULA</span>
      </div>
      <div
        class="hidden md:flex gap-6 glass px-6 py-2 rounded-full pointer-events-auto fade-in-up delay-100 text-xs font-mono tracking-wide uppercase"
      >
        <a href="#" class="hover:text-cyan-400 transition-colors">Simulation</a>
        <a href="#" class="hover:text-cyan-400 transition-colors">Docs</a>
        <a href="#" class="hover:text-cyan-400 transition-colors">Login</a>
      </div>
    </nav>

    <!-- Main UI Overlay -->
    <div
      class="absolute inset-0 z-10 flex flex-col md:flex-row pointer-events-none"
    >
      <!-- Hero Section (Left) -->
      <div
        class="w-full md:w-1/2 h-full flex flex-col justify-center px-8 md:px-20 pt-20 md:pt-0"
      >
        <div class="max-w-xl pointer-events-auto">
          <div
            class="inline-block mb-4 px-3 py-1 rounded border border-cyan-500/30 bg-cyan-500/10 text-cyan-400 text-[10px] font-mono uppercase tracking-widest fade-in-up"
          >
            System V2.4 Online
          </div>
          <h1
            class="text-5xl md:text-7xl font-bold text-white mb-6 leading-tight fade-in-up delay-100"
          >
            Procedural <br />
            <span
              class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-indigo-500"
              >Intelligence.</span
            >
          </h1>
          <p
            class="text-lg text-slate-400 mb-8 leading-relaxed fade-in-up delay-200"
          >
            Experience the convergence of generative geometry and neural
            networks. Interact with the digital core in real-time.
          </p>
          <div class="flex gap-4 fade-in-up delay-300">
            <button
              id="scroll-cta"
              class="bg-white text-black hover:bg-cyan-50 transition-colors px-6 py-3 rounded font-semibold text-sm uppercase tracking-wide"
            >
              Explore Core
            </button>
            <div
              class="flex items-center gap-4 text-xs font-mono text-slate-500"
            >
              <span class="flex items-center gap-2">
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  ></path>
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                  ></path>
                </svg>
                Orbit Enabled
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Control Panel (Right/Bottom) -->
      <div
        class="w-full md:w-1/2 h-auto md:h-full flex flex-col justify-end items-end p-6 md:p-12"
      >
        <div
          class="glass-panel w-full max-w-md rounded-xl p-6 pointer-events-auto fade-in-up delay-300 transition-all duration-300 hover:shadow-[0_0_30px_rgba(0,0,0,0.5)]"
        >
          <div
            class="flex justify-between items-center mb-4 border-b border-white/10 pb-3"
          >
            <h3
              class="font-mono text-xs uppercase text-cyan-400 font-bold flex items-center gap-2"
            >
              <span class="w-1 h-1 bg-cyan-400 rounded-full"></span> Command
              Interface
            </h3>
            <span
              id="connection-status"
              class="text-[10px] text-green-500 font-mono"
              >NET_ACTIVE</span
            >
          </div>

          <!-- Console Output -->
          <div
            id="console"
            class="h-32 bg-black/40 rounded mb-4 p-3 font-mono text-[10px] overflow-y-auto text-slate-400 border border-white/5 shadow-inner"
          >
            <div class="mb-1 text-cyan-500/50">> System Initialized...</div>
            <div class="mb-1 text-cyan-500/50">> OrbitControls: Active</div>
            <div class="mb-1 text-cyan-500/50">> Awaiting Input...</div>
          </div>

          <!-- Controls -->
          <div class="space-y-3">
            <div class="relative">
              <input
                type="text"
                id="ai-input"
                placeholder="Describe a theme (e.g., 'Cyberpunk', 'Nature')"
                class="w-full bg-white/5 border border-white/10 rounded px-4 py-3 text-sm text-white placeholder-slate-600 focus:outline-none focus:border-cyan-500/50 focus:ring-1 focus:ring-cyan-500/50 transition-all font-mono"
              />
              <button
                id="btn-send"
                class="absolute right-2 top-2 bottom-2 bg-white/10 hover:bg-cyan-500 hover:text-white text-slate-400 px-3 rounded transition-all"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  ></path>
                </svg>
              </button>
            </div>

            <div class="flex gap-2">
              <button
                id="btn-analyze"
                class="flex-1 bg-white/5 hover:bg-white/10 text-xs uppercase tracking-wider py-2 rounded border border-white/5 transition-colors text-slate-400 hover:text-white"
              >
                Diagnostics
              </button>
              <button
                id="btn-reset"
                class="px-3 bg-white/5 hover:bg-red-500/20 hover:text-red-400 text-slate-500 rounded border border-white/5 transition-colors"
              >
                RST
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3D Container -->
    <div id="canvas-container" class="absolute inset-0 z-0 bg-[#050508]"></div>

    <!-- Import Map: Defines where to load "three" and addons -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>

    <!-- Module Script -->
    <script type="module">
      // Import from the mapped names
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";

      // --- CONFIGURATION ---
      const APP_CONFIG = {
        coreSize: 1.8,
        particleCount: 1500,
        autoRotateSpeed: 1.0,
      };

      const apiKey = ""; // Provided by environment

      // --- STATE ---
      let scene, camera, renderer, controls;
      let coreMesh, wireMesh, outerDebris;
      let pointLight1, pointLight2;
      let particles;
      let rings = [];

      // --- INITIALIZATION ---
      init();
      animate();

      // --- CORE FUNCTIONS ---
      function init() {
        const container = document.getElementById("canvas-container");

        // 1. Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050508);
        scene.fog = new THREE.FogExp2(0x050508, 0.03);

        // 2. Camera
        camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.set(0, 2, 7);

        // 3. Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Performance opt
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        container.appendChild(renderer.domElement);

        // 4. Orbit Controls
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enablePan = false;
        controls.minDistance = 4;
        controls.maxDistance = 15;
        controls.autoRotate = true;
        controls.autoRotateSpeed = APP_CONFIG.autoRotateSpeed;

        // 5. Lighting
        const ambient = new THREE.AmbientLight(0x222222);
        scene.add(ambient);

        pointLight1 = new THREE.PointLight(0x00ffff, 2, 40);
        pointLight1.position.set(5, 5, 5);
        scene.add(pointLight1);

        pointLight2 = new THREE.PointLight(0xff00ff, 2, 40);
        pointLight2.position.set(-5, -5, 5);
        scene.add(pointLight2);

        const rimLight = new THREE.PointLight(0xffffff, 1, 20);
        rimLight.position.set(0, 5, -10);
        scene.add(rimLight);

        // 6. Objects
        createCore();
        createParticles();
        createRings();

        // 7. Events
        window.addEventListener("resize", onWindowResize);

        // UI Events
        document
          .getElementById("btn-send")
          .addEventListener("click", handleReconfigure);
        document
          .getElementById("ai-input")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") handleReconfigure();
          });
        document
          .getElementById("btn-analyze")
          .addEventListener("click", handleAnalyze);
        document
          .getElementById("btn-reset")
          .addEventListener("click", resetCamera);
      }

      function createCore() {
        // Inner Solid Core
        const geo = new THREE.IcosahedronGeometry(APP_CONFIG.coreSize, 1);
        const mat = new THREE.MeshStandardMaterial({
          color: 0x111111,
          roughness: 0.2,
          metalness: 0.9,
          flatShading: true,
        });
        coreMesh = new THREE.Mesh(geo, mat);
        scene.add(coreMesh);

        // Outer Wireframe
        const wireGeo = new THREE.IcosahedronGeometry(
          APP_CONFIG.coreSize * 1.1,
          2
        );
        const wireMat = new THREE.MeshBasicMaterial({
          color: 0x00ffff,
          wireframe: true,
          transparent: true,
          opacity: 0.15,
          blending: THREE.AdditiveBlending,
        });
        wireMesh = new THREE.Mesh(wireGeo, wireMat);
        scene.add(wireMesh);

        // Debris Field
        const debGeo = new THREE.TetrahedronGeometry(
          APP_CONFIG.coreSize * 1.6,
          0
        );
        // Distort vertices
        const pos = debGeo.attributes.position;
        for (let i = 0; i < pos.count; i++) {
          pos.setXYZ(
            i,
            pos.getX(i) + (Math.random() - 0.5),
            pos.getY(i) + (Math.random() - 0.5),
            pos.getZ(i) + (Math.random() - 0.5)
          );
        }
        const debMat = new THREE.MeshStandardMaterial({
          color: 0x222222,
          roughness: 0.4,
          metalness: 0.8,
          flatShading: true,
        });
        outerDebris = new THREE.Mesh(debGeo, debMat);
        scene.add(outerDebris);
      }

      function createParticles() {
        const geo = new THREE.BufferGeometry();
        const pos = [];
        for (let i = 0; i < APP_CONFIG.particleCount; i++) {
          pos.push(
            (Math.random() - 0.5) * 40,
            (Math.random() - 0.5) * 40,
            (Math.random() - 0.5) * 40
          );
        }
        geo.setAttribute("position", new THREE.Float32BufferAttribute(pos, 3));
        const mat = new THREE.PointsMaterial({
          size: 0.03,
          color: 0x888888,
          transparent: true,
          opacity: 0.6,
        });
        particles = new THREE.Points(geo, mat);
        scene.add(particles);
      }

      function createRings() {
        const create = (r, t, c, rot) => {
          const geo = new THREE.TorusGeometry(r, t, 16, 100);
          const mat = new THREE.MeshBasicMaterial({
            color: c,
            transparent: true,
            opacity: 0.4,
          });
          const mesh = new THREE.Mesh(geo, mat);
          mesh.rotation.x = Math.random() * Math.PI;
          mesh.userData = { axis: rot, speed: 0.002 + Math.random() * 0.005 };
          scene.add(mesh);
          rings.push(mesh);
        };
        create(3.5, 0.02, 0x00ffff, new THREE.Vector3(1, 0.5, 0));
        create(4.5, 0.01, 0xff00ff, new THREE.Vector3(0.2, 1, 0.2));
      }

      function animate() {
        requestAnimationFrame(animate);

        const time = Date.now() * 0.001;

        // Idle Animations
        coreMesh.rotation.y += 0.002;
        wireMesh.rotation.y -= 0.001;
        outerDebris.rotation.x += 0.003;
        outerDebris.rotation.z += 0.001;

        // Pulse
        const scale = 1 + Math.sin(time) * 0.02;
        coreMesh.scale.setScalar(scale);
        wireMesh.scale.setScalar(scale);

        // Rings
        rings.forEach((r) => {
          r.rotation.x += r.userData.axis.x * r.userData.speed;
          r.rotation.y += r.userData.axis.y * r.userData.speed;
        });

        // Particles
        particles.rotation.y = time * 0.05;

        controls.update();
        renderer.render(scene, camera);
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function resetCamera() {
        // Smooth reset
        const duration = 1000;
        const startPos = camera.position.clone();
        const endPos = new THREE.Vector3(0, 2, 7);
        const startTime = Date.now();

        function tween() {
          const now = Date.now();
          const progress = Math.min((now - startTime) / duration, 1);
          const ease = 1 - Math.pow(1 - progress, 3); // EaseOutCubic

          camera.position.lerpVectors(startPos, endPos, ease);
          controls.target.set(0, 0, 0);

          if (progress < 1) requestAnimationFrame(tween);
        }
        tween();
        logToConsole("Camera reset.");
      }

      // --- AI LOGIC (Gemini) ---

      async function callGemini(
        prompt,
        systemInstruction = "",
        isJson = false
      ) {
        // Fallback logic immediately if no key, or error handling
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const payload = {
          contents: [{ parts: [{ text: prompt }] }],
          systemInstruction: { parts: [{ text: systemInstruction }] },
          generationConfig: isJson
            ? { responseMimeType: "application/json" }
            : undefined,
        };

        try {
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) throw new Error("API_FAIL");
          const data = await res.json();
          return data.candidates[0].content.parts[0].text;
        } catch (e) {
          console.warn("AI Offline, using fallback.");
          return isJson
            ? getLocalConfig()
            : "Connection unstable. Local diagnostics running...";
        }
      }

      function getLocalConfig() {
        const randColor = () =>
          "#" +
          Math.floor(Math.random() * 16777215)
            .toString(16)
            .padStart(6, "0");
        return JSON.stringify({
          coreColor: randColor(),
          wireColor: randColor(),
          lightColor: randColor(),
          bgHex: "#050508",
          msg: "LOCAL_OVERRIDE",
        });
      }

      async function handleReconfigure() {
        const input = document.getElementById("ai-input").value;
        if (!input) return;

        logToConsole(`Processing: "${input}"...`);
        toggleLoading(true);

        const sysPrompt = `Generate a JSON config for a 3D scene based on the user's mood/theme.
            Schema: { "coreColor": "#hex", "wireColor": "#hex", "lightColor": "#hex", "bgHex": "#hex (dark)", "msg": "Short status" }`;

        const res = await callGemini(`Theme: ${input}`, sysPrompt, true);

        try {
          const data = JSON.parse(res);

          // Apply colors
          new THREE.Color(data.coreColor).getHSL({ h: 0, s: 0, l: 0 }); // validate

          // Helper to animate color
          const animateColor = (obj, hex) => {
            if (!obj) return;
            const start = obj.getHex();
            const end = new THREE.Color(hex).getHex();
            // Simple lerp effect could go here, direct set for now
            obj.setHex(end);
          };

          animateColor(coreMesh.material.color, data.coreColor);
          animateColor(wireMesh.material.color, data.wireColor);
          animateColor(pointLight1.color, data.lightColor);
          animateColor(pointLight2.color, data.lightColor); // Mirror for balance

          if (data.bgHex) {
            animateColor(scene.background, data.bgHex);
            animateColor(scene.fog.color, data.bgHex);
          }

          // Update UI
          document.getElementById("core-status").style.backgroundColor =
            data.wireColor;
          document.getElementById(
            "core-status"
          ).style.boxShadow = `0 0 10px ${data.wireColor}`;

          logToConsole(`Reconfig Complete: ${data.msg}`, "text-green-400");
        } catch (e) {
          logToConsole("Config parsing failed.", "text-red-400");
        }

        toggleLoading(false);
        document.getElementById("ai-input").value = "";
      }

      async function handleAnalyze() {
        logToConsole("Scanning geometry...");
        const desc = await callGemini(
          "Analyze current system state. Sci-fi style, brief.",
          "You are a spaceship AI.",
          false
        );
        logToConsole(desc);
      }

      function logToConsole(text, colorClass = "text-slate-400") {
        const c = document.getElementById("console");
        const div = document.createElement("div");
        div.className = `mb-1 ${colorClass} border-l-2 border-transparent pl-2 fade-in-up`;
        div.innerText = `> ${text}`;
        c.appendChild(div);
        c.scrollTop = c.scrollHeight;
      }

      function toggleLoading(isLoading) {
        const btn = document.getElementById("btn-send");
        if (isLoading) {
          btn.innerHTML = '<div class="loader"></div>';
          btn.classList.add("opacity-50", "pointer-events-none");
        } else {
          btn.innerHTML =
            '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>';
          btn.classList.remove("opacity-50", "pointer-events-none");
        }
      }
    </script>
  </body>
</html>
